<!DOCTYPE HTML>
<html>

<head>
    <title>Pomodoro</title>
    <meta charset="utf-8"/>
</head>

<body>
<script>
    let TARGET_HARDWARE_AND_SOFTWARE = 0;
    let LONG_PRESS_MS = 500;

    let EVENT_KEY_DOWN = "keyDown"
    let EVENT_KEY_UP = "keyUp"
    let EVENT_WILL_APPEAR = "willAppear"

    var websocket = null;
    var pluginUUID = null;

    var keyPressTimer;

    var counterAction = {
        type: "com.glutexo.pomodoro.action",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
            keyPressTimer = setTimeout(function () {
                var updatedSettings = {};
                updatedSettings["keyPressCounter"] = -1;

                counterAction._setSettings(context, updatedSettings);
                counterAction._setTitle(context, 0);
            }, LONG_PRESS_MS);
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {

            clearTimeout(keyPressTimer);

            var keyPressCounter = 0;
            if (settings != null && settings.hasOwnProperty('keyPressCounter')) {
                keyPressCounter = settings["keyPressCounter"];
            }

            keyPressCounter++;

            updatedSettings = {};
            updatedSettings["keyPressCounter"] = keyPressCounter;

            this._setSettings(context, updatedSettings);
            this._setTitle(context, keyPressCounter);
        },

        onWillAppear: function (context, settings, coordinates) {

            var keyPressCounter = 60;
            if (settings != null && settings.hasOwnProperty('keyPressCounter')) {
                keyPressCounter = settings["keyPressCounter"];
            }

            updatedSettings = {};
            updatedSettings["keyPressCounter"] = keyPressCounter;

            this._setSettings(context, updatedSettings);
            this._setTitle(context, keyPressCounter);
        },

        _setPomodoroTimer: function (seconds) {
            let settings = {"pomodoroTimer": seconds};

            this._setSettings(context, settings);
            this._setTitle(context, keyPressCounter);

        },

        _setTitle: function (context, keyPressCounter) {
            let json = {
                "event": "setTitle",
                "context": context,
                "payload": {
                    "title": "" + keyPressCounter,
                    "target": TARGET_HARDWARE_AND_SOFTWARE
                }
            };

            websocket.send(JSON.stringify(json));
        },

        _setSettings: function (context, settings) {
            let json = {
                "event": "setSettings",
                "context": context,
                "payload": settings
            };

            websocket.send(JSON.stringify(json));
        }
    };

    function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID

        // Open the web socket
        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
            let registration = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID
            }, json = JSON.stringify(registration);
            websocket.send(json);
        }

        websocket.onopen = function () {
            // WebSocket is connected, send message
            registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (received_event) {
            // Received message from Stream Deck
            let received_event_data = JSON.parse(received_event.data);

            if (received_event_data["event"] === EVENT_KEY_DOWN) {
                var jsonPayload = received_event_data["payload"];
                counterAction.onKeyDown(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                    received_event_data["payload"]["userDesiredState"],
                );
            } else if (received_event_data["event"] === EVENT_KEY_UP) {
                counterAction.onKeyUp(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                    received_event_data["payload"]["userDesiredState"],
                );
            } else if (received_event_data["event"] === EVENT_WILL_APPEAR) {
                counterAction.onWillAppear(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                );
            }
        };

        websocket.onclose = function () {
            // Websocket is closed
        };
    }
</script>
</body>
</html>
