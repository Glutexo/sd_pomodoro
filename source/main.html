<!DOCTYPE HTML>
<html>

<head>
    <title>Pomodoro</title>
    <meta charset="utf-8"/>
</head>

<body>
<script>
    const TARGET_HARDWARE_AND_SOFTWARE = 0;
    const LONG_PRESS_MS = 500;
    const POMODORO_TICK_MS = 1000;
    const POMODORO_INITIAL_SECONDS = 60;

    const EVENT_KEY_DOWN = "keyDown"
    const EVENT_KEY_UP = "keyUp"
    const EVENT_WILL_APPEAR = "willAppear"

    const actions = {
        onKeyDown: function (context, settings, coordinates, userDesiredState) {
            keyPressTimer = setTimeout(function () {
                clearInterval(pomodoroTimer)
                _setPomodoroSeconds(context, POMODORO_INITIAL_SECONDS)
                longPress = true;
            }, LONG_PRESS_MS);
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
            clearTimeout(keyPressTimer);

            if (longPress) {
                longPress = false;
                return
            }

            _togglePomodoroTimer(context, settings)
        },

        onWillAppear: function (context, settings, coordinates) {
            pomodoroSeconds = POMODORO_INITIAL_SECONDS;
            if (settings != null && settings.hasOwnProperty("pomodoroSeconds")) {
                pomodoroSeconds = settings["pomodoroSeconds"];
            }
            _setPomodoroSeconds(context, pomodoroSeconds)
        },
    }

    let websocket = null;
    let pluginUUID = null;

    let keyPressTimer;
    let longPress = false;

    let pomodoroTimer;
    let pomodoroSeconds;

    function _pomodoroTick(context, settings) {
        pomodoroSeconds--;
        _setPomodoroSeconds(context, pomodoroSeconds)
    }

    function _togglePomodoroTimer(context, settings) {
        function __pomodoroTick() {
            _pomodoroTick(context, settings);
        }

        if (pomodoroTimer) {
            clearInterval(pomodoroTimer);
        } else {
            pomodoroTimer = setInterval(__pomodoroTick, POMODORO_TICK_MS)
        }
    }

    function _setPomodoroSeconds(context, pomodoroSeconds) {
        let settings = {"pomodoroSeconds": pomodoroSeconds};
        _setSettings(context, settings);
        _setTitle(context, pomodoroSeconds);
    }

    function _setSettings(context, settings) {
        let data = {
            "event": "setSettings",
            "context": context,
            "payload": settings
        };
        let json = JSON.stringify(data);

        websocket.send(json);
    }

    function _setTitle(context, title) {
        let data = {
            "event": "setTitle",
            "context": context,
            "payload": {
                "title": "" + title,
                "target": TARGET_HARDWARE_AND_SOFTWARE
            }
        };
        let json = JSON.stringify(data)

        websocket.send(json);
    }


    function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID

        // Open the web socket
        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
            let registration = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID
            }, json = JSON.stringify(registration);
            websocket.send(json);
        }

        websocket.onopen = function () {
            // WebSocket is connected, send message
            registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (received_event) {
            // Received message from Stream Deck
            let received_event_data = JSON.parse(received_event.data);

            if (received_event_data["event"] === EVENT_KEY_DOWN) {
                var jsonPayload = received_event_data["payload"];
                actions.onKeyDown(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                    received_event_data["payload"]["userDesiredState"],
                );
            } else if (received_event_data["event"] === EVENT_KEY_UP) {
                actions.onKeyUp(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                    received_event_data["payload"]["userDesiredState"],
                );
            } else if (received_event_data["event"] === EVENT_WILL_APPEAR) {
                actions.onWillAppear(
                    received_event_data["context"],
                    received_event_data["payload"]["settings"],
                    received_event_data["payload"]["coordinates"],
                );
            }
        };

        websocket.onclose = function () {
            // Websocket is closed
        };
    }
</script>
</body>
</html>
